<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Unit testing the TCR runtime module · Cryptoeconomics.Study</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="&lt;p&gt;This is Part 2 of the guide &lt;a href=&quot;/ces-website/docs/en/tutorials/tcr/&quot;&gt;Building a Token Curated Registry DAppChain on Substrate&lt;/a&gt;. In &lt;a href=&quot;/ces-website/docs/en/tutorials/tcr/building-the-substrate-tcr-runtime&quot;&gt;part 1&lt;/a&gt;, we built a Substrate runtime module for a simple Token Curated Registry implementation. In this part, we cover unit testing of the TCR runtime module.&lt;/p&gt;
"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Unit testing the TCR runtime module · Cryptoeconomics.Study"/><meta property="og:type" content="website"/><meta property="og:url" content="https://burrrata.github.io/ces-website/"/><meta property="og:description" content="&lt;p&gt;This is Part 2 of the guide &lt;a href=&quot;/ces-website/docs/en/tutorials/tcr/&quot;&gt;Building a Token Curated Registry DAppChain on Substrate&lt;/a&gt;. In &lt;a href=&quot;/ces-website/docs/en/tutorials/tcr/building-the-substrate-tcr-runtime&quot;&gt;part 1&lt;/a&gt;, we built a Substrate runtime module for a simple Token Curated Registry implementation. In this part, we cover unit testing of the TCR runtime module.&lt;/p&gt;
"/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/ces-website/img/favicon.ico"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.1.14/dist/vanilla-back-to-top.min.js"></script><script>
        document.addEventListener('DOMContentLoaded', function() {
          addBackToTop(
            {"zIndex":100}
          )
        });
        </script><script src="/ces-website/js/scrollSpy.js"></script><link rel="stylesheet" href="/ces-website/css/prism.css"/><link rel="stylesheet" href="/ces-website/css/main.css"/><script src="/ces-website/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/ces-website/en"><img class="logo" src="/ces-website/img/ces-logo.png" alt="Cryptoeconomics.Study"/><h2 class="headerTitleWithLogo">Cryptoeconomics.Study</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/ces-website/docs/en/getting-started/welcome" target="_self">Course</a></li><li class=""><a href="https://forum.cryptoeconomics.study" target="_self">Community</a></li><li class=""><a href="https://forum.cryptoeconomics.study/t/official-contribution-guidelines/453" target="_self">Contribute</a></li><span><li><a id="languages-menu" href="#"><img class="languages-icon" src="/ces-website/img/language.svg" alt="Languages icon"/>English</a><div id="languages-dropdown" class="hide"><ul id="languages-dropdown-items"><li><a href="/ces-website/docs/zh-CN/tutorials/tcr/unit-testing-the-tcr-runtime-module">中文</a></li></ul></div></li><script>
        const languagesMenuItem = document.getElementById("languages-menu");
        const languagesDropDown = document.getElementById("languages-dropdown");
        languagesMenuItem.addEventListener("click", function(event) {
          event.preventDefault();

          if (languagesDropDown.className == "hide") {
            languagesDropDown.className = "visible";
          } else {
            languagesDropDown.className = "hide";
          }
        });
      </script></span></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle">Unit testing the TCR runtime module</h1></header><article><div><span><p>This is Part 2 of the guide <a href="/ces-website/docs/en/tutorials/tcr/">Building a Token Curated Registry DAppChain on Substrate</a>. In <a href="/ces-website/docs/en/tutorials/tcr/building-the-substrate-tcr-runtime">part 1</a>, we built a Substrate runtime module for a simple Token Curated Registry implementation. In this part, we cover unit testing of the TCR runtime module.</p>
<h2><a class="anchor" aria-hidden="true" id="setup-and-mocks"></a><a href="#setup-and-mocks" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Setup and mocks</h2>
<p>To write unit tests for the business logic of our runtime module, we first need to set up the test module. Basically, we would need a mock runtime for testing. We would also need to implement all the traits that we need in our module for this mock runtime.</p>
<h3><a class="anchor" aria-hidden="true" id="mocking-module-dependencies"></a><a href="#mocking-module-dependencies" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Mocking module dependencies</h3>
<p>Remember from part 1 that our TCR runtime module trait depends on the <code>timestamp</code> and <code>token</code> module traits. All modules depend on the <code>system</code> module for utilities and cross-cutting functions. So, for our test module, we need to implement the <code>system</code>, <code>timestamp</code>, and <code>token</code> traits.</p>
<p>In the following code snippet, we create the module type for the test module and then implement the required traits for it. Also, note that we have used simpler types for our mock runtime. For example, the <code>AccountId</code> is simply a <code>u64</code>.</p>
<pre><code class="hljs css language-rust">  <span class="token keyword">pub</span> <span class="token keyword">struct</span> Test<span class="token punctuation">;</span>
  <span class="token keyword">impl</span> system<span class="token punctuation">:</span><span class="token punctuation">:</span>Trait <span class="token keyword">for</span> Test <span class="token punctuation">{</span>
    <span class="token keyword">type</span> Origin <span class="token operator">=</span> Origin<span class="token punctuation">;</span>
    <span class="token keyword">type</span> Index <span class="token operator">=</span> u64<span class="token punctuation">;</span>
    <span class="token keyword">type</span> BlockNumber <span class="token operator">=</span> u64<span class="token punctuation">;</span>
    <span class="token keyword">type</span> Hash <span class="token operator">=</span> H256<span class="token punctuation">;</span>
    <span class="token keyword">type</span> Hashing <span class="token operator">=</span> BlakeTwo256<span class="token punctuation">;</span>
    <span class="token keyword">type</span> Digest <span class="token operator">=</span> Digest<span class="token punctuation">;</span>
    <span class="token keyword">type</span> AccountId <span class="token operator">=</span> u64<span class="token punctuation">;</span>
    <span class="token keyword">type</span> Lookup <span class="token operator">=</span> IdentityLookup<span class="token operator">&lt;</span>u64<span class="token operator">></span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> Header <span class="token operator">=</span> Header<span class="token punctuation">;</span>
    <span class="token keyword">type</span> Event <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> Log <span class="token operator">=</span> DigestItem<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">impl</span> token<span class="token punctuation">:</span><span class="token punctuation">:</span>Trait <span class="token keyword">for</span> Test <span class="token punctuation">{</span>
    <span class="token keyword">type</span> Event <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> TokenBalance <span class="token operator">=</span> u64<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">impl</span> timestamp<span class="token punctuation">:</span><span class="token punctuation">:</span>Trait <span class="token keyword">for</span> Test <span class="token punctuation">{</span>
    <span class="token keyword">type</span> Moment <span class="token operator">=</span> u64<span class="token punctuation">;</span>
    <span class="token keyword">type</span> OnTimestampSet <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">impl</span> Trait <span class="token keyword">for</span> Test <span class="token punctuation">{</span>
    <span class="token keyword">type</span> Event <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">type</span> Tcr <span class="token operator">=</span> Module<span class="token operator">&lt;</span>Test<span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token keyword">type</span> Token <span class="token operator">=</span> token<span class="token punctuation">:</span><span class="token punctuation">:</span>Module<span class="token operator">&lt;</span>Test<span class="token operator">></span><span class="token punctuation">;</span>
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="mocking-genesis-config"></a><a href="#mocking-genesis-config" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Mocking genesis config</h3>
<p>The next step is to mock the genesis config for the TCR and Token modules. Remember from part 1 that we declared and initialized the genesis config for our runtime modules. When the tests run, they also require the genesis config to be available. In the following code snippet, we have a function that runs before every test and initializes the genesis config with some mock values. Note that wherever we've used <code>AccountId</code> in the genesis config (owner), we've set a <code>u64</code> value because the <code>AccountId</code> type is implemented that way for the mock runtime (see above).</p>
<pre><code class="hljs css language-rust">  <span class="token keyword">fn</span> <span class="token function">new_test_ext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> runtime_io<span class="token punctuation">:</span><span class="token punctuation">:</span>TestExternalities<span class="token operator">&lt;</span>Blake2Hasher<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> t <span class="token operator">=</span> system<span class="token punctuation">:</span><span class="token punctuation">:</span>GenesisConfig<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>Test<span class="token operator">></span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">build_storage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">;</span>
    t<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>
      token<span class="token punctuation">:</span><span class="token punctuation">:</span>GenesisConfig<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>Test<span class="token operator">></span> <span class="token punctuation">{</span> total_supply<span class="token punctuation">:</span> <span class="token number">1000</span> <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token function">build_storage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    t<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>
      GenesisConfig<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>Test<span class="token operator">></span> <span class="token punctuation">{</span>
        owner<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        min_deposit<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
        apply_stage_len<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
        commit_stage_len<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
        poll_nonce<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
      <span class="token punctuation">.</span><span class="token function">build_storage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    t<span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre>
<p>Note that we've also mocked the genesis config (<code>total_supply</code>) for the <code>Token</code> module because it is internally needed in the TCR module's <code>init</code> function.</p>
<h2><a class="anchor" aria-hidden="true" id="writing-the-tests"></a><a href="#writing-the-tests" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Writing the tests</h2>
<p>Now that we've mocked our runtime and genesis config, we are good to proceed with writing unit tests for the TCR module.</p>
<p>Let's begin with writing a simple test to check if a proposal fails when passed with deposit lower than min_deposit,</p>
<pre><code class="hljs css language-rust">  <span class="token attribute attr-name">#[test]</span>
  <span class="token keyword">fn</span> <span class="token function">should_fail_low_deposit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">with_externalities</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token function">new_test_ext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token closure-params"><span class="token punctuation">|</span><span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
      <span class="token function">assert_noop!</span><span class="token punctuation">(</span>
        Tcr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">propose</span><span class="token punctuation">(</span>Origin<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">signed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"ListingItem1"</span><span class="token punctuation">.</span><span class="token function">as_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"deposit should be more than min_deposit"</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre>
<p>Note the <code>assert_noop</code> macro call in the above snippet. It expects the function to fail with an error message to compare with.</p>
<p>Now, let's write a test for a successful proposal,</p>
<pre><code class="hljs css language-rust">  <span class="token attribute attr-name">#[test]</span>
  <span class="token keyword">fn</span> <span class="token function">should_pass_propose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">with_externalities</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token function">new_test_ext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token closure-params"><span class="token punctuation">|</span><span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
      <span class="token function">assert_ok!</span><span class="token punctuation">(</span>Tcr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span>Origin<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">signed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">assert_ok!</span><span class="token punctuation">(</span>Tcr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">propose</span><span class="token punctuation">(</span>
        Origin<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">signed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"ListingItem1"</span><span class="token punctuation">.</span><span class="token function">as_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token number">101</span>
      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre>
<p>In the above snippet, the test first initializes the TCR by calling the <code>init</code> function and then calls the propose function with correct values. The <code>assert_ok</code> macro expects an <code>Ok(())</code> result.</p>
<p>Similarly, we can write other tests covering more logic in our runtime. We have a few more tests in the TCR sample codebase <a href="https://github.com/substrate-developer-hub/substrate-tcr/blob/master/runtime/src/tcr.rs#L470">here</a>.</p>
<p>When writing the unit tests for your runtime modules, it is recommended to refer to the test written for SRML modules which ship with the Substrate framework. The SRML modules have good code coverage and can provide guidance on how to write tests in more complex scenarios.</p>
<p>In the <a href="/ces-website/docs/en/tutorials/tcr/building-a-ui-for-the-tcr-runtime">next part</a> of this guide, we will learn how we can call these runtime functions from a <code>reactjs</code> frontend using the <code>PolkadotJS</code> API.</p>
</span></div></article></div><div class="docLastUpdate"><em>Last updated on 7/13/2019 by burrrata</em></div><div class="docs-prevnext"></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#setup-and-mocks">Setup and mocks</a><ul class="toc-headings"><li><a href="#mocking-module-dependencies">Mocking module dependencies</a></li><li><a href="#mocking-genesis-config">Mocking genesis config</a></li></ul></li><li><a href="#writing-the-tests">Writing the tests</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/ces-website/" class="nav-home"></a><div><h5>Docs</h5><a href="/ces-website/docs/en/getting-started/welcome">Course</a><a href="/ces-website/en/coding-challenges">Coding Challenges</a><a href="https://forum.cryptoeconomics.study/">Community</a></div><div><h5>Community</h5><a href="/ces-website/en/users.html">Contributors</a><a href="https://forum.cryptoeconomics.study/">Forum</a></div><div><h5>More</h5><a href="/ces-website/blog">Blog</a><a href="https://github.com/cryptoeconomics-study/">GitHub</a></div></section><section class="copyright">Copyright © 2019 Cryptoeconomics.Study</section></footer></div></body></html>