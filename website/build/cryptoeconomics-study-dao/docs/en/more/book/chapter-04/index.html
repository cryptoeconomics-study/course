<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>more/book/chapter-04 · Cryptoeconomics.Study</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="&lt;h1&gt;&lt;a class=&quot;anchor&quot; aria-hidden=&quot;true&quot; id=&quot;chapter-4-proof-of-stake&quot;&gt;&lt;/a&gt;&lt;a href=&quot;#chapter-4-proof-of-stake&quot; aria-hidden=&quot;true&quot; class=&quot;hash-link&quot;&gt;&lt;svg class=&quot;hash-link-icon&quot; aria-hidden=&quot;true&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Chapter 4: Proof of Stake&lt;/h1&gt;
"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="more/book/chapter-04 · Cryptoeconomics.Study"/><meta property="og:type" content="website"/><meta property="og:url" content="https://burrrata.github.io/cryptoeconomics-study-dao/"/><meta property="og:description" content="&lt;h1&gt;&lt;a class=&quot;anchor&quot; aria-hidden=&quot;true&quot; id=&quot;chapter-4-proof-of-stake&quot;&gt;&lt;/a&gt;&lt;a href=&quot;#chapter-4-proof-of-stake&quot; aria-hidden=&quot;true&quot; class=&quot;hash-link&quot;&gt;&lt;svg class=&quot;hash-link-icon&quot; aria-hidden=&quot;true&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Chapter 4: Proof of Stake&lt;/h1&gt;
"/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/cryptoeconomics-study-dao/img/favicon.ico"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.1.14/dist/vanilla-back-to-top.min.js"></script><script>
        document.addEventListener('DOMContentLoaded', function() {
          addBackToTop(
            {"zIndex":100}
          )
        });
        </script><script src="/cryptoeconomics-study-dao/js/scrollSpy.js"></script><link rel="stylesheet" href="/cryptoeconomics-study-dao/css/prism.css"/><link rel="stylesheet" href="/cryptoeconomics-study-dao/css/main.css"/><script src="/cryptoeconomics-study-dao/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/cryptoeconomics-study-dao/en"><img class="logo" src="/cryptoeconomics-study-dao/img/ces-logo.png" alt="Cryptoeconomics.Study"/><h2 class="headerTitleWithLogo">Cryptoeconomics.Study</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/cryptoeconomics-study-dao/docs/en/getting-started/welcome" target="_self">Course</a></li><li class=""><a href="community" target="_self">Community</a></li><li class=""><a href="/cryptoeconomics-study-dao/docs/en/dao/welcome" target="_self">Contribute</a></li><span><li><a id="languages-menu" href="#"><img class="languages-icon" src="/cryptoeconomics-study-dao/img/language.svg" alt="Languages icon"/>English</a><div id="languages-dropdown" class="hide"><ul id="languages-dropdown-items"><li><a href="/cryptoeconomics-study-dao/docs/zh-CN/more/book/chapter-04">中文</a></li></ul></div></li><script>
        const languagesMenuItem = document.getElementById("languages-menu");
        const languagesDropDown = document.getElementById("languages-dropdown");
        languagesMenuItem.addEventListener("click", function(event) {
          event.preventDefault();

          if (languagesDropDown.className == "hide") {
            languagesDropDown.className = "visible";
          } else {
            languagesDropDown.className = "hide";
          }
        });
      </script></span></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle">more/book/chapter-04</h1></header><article><div><span><h1><a class="anchor" aria-hidden="true" id="chapter-4-proof-of-stake"></a><a href="#chapter-4-proof-of-stake" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Chapter 4: Proof of Stake</h1>
<h2><a class="anchor" aria-hidden="true" id="working-draft"></a><a href="#working-draft" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WORKING DRAFT</h2>
<p>So far we have talked about Proof-of-Work which is the protocol that Bitcoin uses to come to consensus. However, Bitcoin’s proof of work has a lot of problems, the biggest of which is scalability and energy consumption. Bitcoin is claimed to use up as much energy as the country Iceland. Furthermore, this energy consumption isn’t justified because a decentralized payment system that is much slower than any bank or centralized institution that exists today is not a viable replacement. If you were to buy coffee with bitcoin today, you would end up with cold coffee. Naturally, these are sufficient reasons why there is a need for alternative sybil control mechanisms. Proof-of-Stake is one of the most talked about sybil control mechanisms proposed. Ethereum, Cardano, EOS, Tendermint, Algorand, ThunderToken are some of the biggest projects which are all using Proof-of-Stake. In this chapter we will understand what Proof-of-stake is and why it is a scalable and energy efficient alternative to Proof-of-Work.</p>
<p><strong>What is Proof of Stake?</strong></p>
<p>Proof-of-Stake is an alternative decentralized sybil control protocol design family that can be layered on any consensus mechanism. The idea behind this family of protocols is that voting power is directly proportional to the stake or number of coins held by a “validator”. Validators perform the job that miners in proof-of-work perform, their responsibility is take care of the functioning of the blockchain network for which they are usually rewarded with transaction fees and block rewards. The belief is that stakeholders of the blockchain are economically rational and hence are incentivized to act honestly because the value of their money diminishes any time the trust in the blockchain system wanes.
There are several ways of classifying the idea of Proof-of-Stake. One common way is based on if users can also gain a share of rewards in protocol by sending their rewards to validators that the user trusts and having the validator act on the user’s behalf also called as “delegating”. When the user can act as a delegator, the protocol is often classified as Delegated Proof-of-Stake. Another classification is along the lines of if the Proof-of-Stake protocol ensures that once a block has been added to the blockchain it will be considered as the final view and cannot be removed or forked at that height.  This property is referred to as finality. “BFT based” Proof-of-Stakes ensure immediate finality at every block while “Chain based” Proof-of-Stakes use a concept of eventual finality or the idea that when many blocks are added on top of the current block the probability of the current block being replaced becomes very low.
Proof-of-Stakes can have several other variations based on if rewards are given to validators, their randomness source, their network assumptions and many more parameters. For the rest of the chapter we focus on solely on Ethereum’s designs. To learn more about how these compare to other Proof-of-Stakes you can see<a href="http://https://github.com/Mechanism-Labs/MetaAnalysis-of-Alternative-Consensus-Protocols" title=" this chart"> this chart</a>.</p>
<p><strong>Naive Proof of Stake and the nothing at stake problem.</strong></p>
<p>In early versions of proof of stake, specifically in chain based proof of stakes, there was nothing penalizing conflicting votes. This means that validators could vote on multiple conflicting histories without any repercussions. It was actually economically rational for validators to vote on multiple chains, since it would mean that they had a higher expected reward.
<a href="http://https://github.com/ethereum/wiki/wiki/Proof-of-Stake-FAQs#what-is-the-nothing-at-stake-problem-and-how-can-it-be-fixed" title="Nothing at stake attack in chain based systems"><img src="https://raw.githubusercontent.com/vbuterin/diagrams/master/possec.png" alt="Nothing at stake attack in chain based systems" title="Nothing at stake attack in chain based systems"></a>
<a href="https://github.com/ethereum/wiki/wiki/Proof-of-Stake-FAQs#what-is-the-nothing-at-stake-problem-and-how-can-it-be-fixedhttp://" title="Nothing At Stake in Chain Based systems">Nothing At Stake in Chain Based systems</a></p>
<p>This is problematic because if there ever is a fork in the blockchain history, there is little incentive for anyone to ever resolve the fork. Thus, a chain based proof-of-stake system with no penalties and only rewards never comes to agreement on a single transaction history. This attack is called the nothing at stake problem because there is no penalty and only a reward for acting in a dishonest manner. Although one can argue that if someone holds a lot of stake, it is still in their incentive to eventually have the blockchain converge to ensure that the price of the staking token doesn’t fall drastically and incentivize more usage of the blockchain. Thus, nothing at stake might be an attack if proof of stake is modelled from the perspective of just one round, but if proof-of-stake is modelled from the perspective of multiple rounds it may no longer be an attack vector.</p>
<p><strong>Solving nothing at stake by introducing slashing.</strong></p>
<p>One way to present nothing at stake is by penalizing validators who vote on multiple conflicting histories. This is only a solution for systems where there are rewards. If there are no rewards, penalizing stakeholders would disincentivize them from participating.
In order to penalize any malicious actor, detecting malicious behaviour is important. It is relatively easy to detect double signing of two conflicting histories at the same height. Thus any honest node who constructs and submits a proof of fraudulent behaviour as a transaction into the blockchain can redeem a reward for catching bad actors. The malicious validator in turn gets punished by losing some portion of their stake tokens.
The threat of losing tokens disincentivizes validators from creating conflicting histories at the same height. There are multiple versions of slashing that have been thought about. One type of slashing is called slashing for voting on multiple chains, while another type of slashing tries to mimic proof-of-work by slashing a validator who votes on the wrong chain.
The new payoff matrices look something like the ones below:</p>
<p><img src="https://github.com/vbuterin/diagrams/raw/master/slasher1sec.png?raw=true" alt="Slasher on multiple chains" title="Slasher on multiple chains">
Slashing for voting on the multiple chains</p>
<p><img src="https://github.com/vbuterin/diagrams/raw/master/slasher2sec.png?raw=true" alt="">
Slashing for voting on the wrong chain</p>
<p><strong>Slashing conditions case studies: Casper FFG</strong></p>
<ul>
<li>Use proof of work to propose blocks (can also randomly sample to propose blocks)</li>
<li>Vote on epochs every 50 blocks</li>
<li>Slashing conditions: 1) NO_DBL_VOTE &amp; 2) NO_SURROUND_VOTE</li>
<li>2/3 threshold for finality means we require 1/3 coins to be slashed if two histories finalize</li>
<li>Formal verification: quick look at isabelle proof for casper slashing conditions, and discuss importance of both valiation and verification</li>
</ul>
<p><strong>Slashing Conditions Case Study: Casper FFG</strong></p>
<p>Casper FFG is a chain based hybrid proof of stake that plans to use proof of work as the randomness generation mechanism to to propose blocks. However, proof-of-work only provides probabilistic finality. In order to ensure that any transaction included in the blockchain is not going to be displaced, finality is important. Proof-of-stake is layered at the end of every epoch i.e around 50 blocks to ensure finality in Casper FFG. Validators on casper can check for malicious behavior by looking out for the following two conditions:</p>
<ol>
<li>NO_DBL_VOTE</li>
<li>NO_SURROUND_VOTE
A general proof of stake round has a leader who proposes a certain value and requires ⅔ staking power to agree on the right value. The assumption that such a voting system makes is that there are less than ⅓ malicious actors in the system. In fact, because of the byzantine generals problem and impossibility result, the proof of stake mechanism needs this assumption to hold. This means that if we ever finalize two conflicting histories, then more than ⅓ of the staking power is in the hands malicious actors. This also means that ⅓ of the coins need to be slashed.</li>
</ol>
<p><strong>Advanced PoS Systems</strong></p>
<p>Any Proof of stake system also needs to deal with Validator set changes i.e there should be different validators for different rounds. This is important for two reasons
Permissionless: Any proof-of-stake system should also enable validators to go offline and come back online. This is important because initially there might be a lot of interest for people to join as a validator but if they don’t make a lot of rewards they might want to stop being validators. In bitcoin anyone can join or leave at any time that they want. This is what it means for a system to be permissionless.
Scalability: This enables more people to participate as validators while ensuring that the system is scalable. Sending messages across the internet is expensive thus it is it becomes costly to have a huge validator set for every round of proof-of-stake.
Casper ensures validators can join and leave as long as there is a sufficient bonding and unbonding period. Thus validator sets can only change once there are two consecutive finalized blocks. This is to defend against short range attacks i.e a validator forks the history and immediately unbonds thus cannot be slashed for acting badly.
Another consideration with validator sets is to ensure that minority isn’t grieved or trapped in forever. If for example the majority is dishonest, then the minority will not be able to unbond their stake and leave the system because finality is never reached. In order to resist such an attack, we introduce leaking. Leaking allows minority validators to soft fork to their own chain, and then over a period of time, they will have control of a majority of stake on their soft fork chain. This allows them to reach finality &amp; effectively coordinate a hard fork. The minority could always sell their private keys to the validator in the worst case, however that is not an ideal fall back mechanism because that leads to several signature based attacks. No one else might be willing to buy the private keys if they hear that the network is under attack and if the market doesn’t know that the network is under attack, such an attempt to sell keys will definitely inform the market and cause chaotic markets.</p>
<p><strong>RanDAO block proposal</strong></p>
<p>Proof of work is both a sybil control mechanism and a source of randomness. Casper FFG uses a hybrid of proof of stake and proof of work. In order to completely replace proof of work, one also needs a randomness generation mechanism. Randao is one approach to generate randomness.
Randao uses a scheme called onion hashing described below:
Hash a random value 10000 times, and then commit to the last hash in the chain.
Each time it is your turn, you reveal the previous hash in the chain. This is checked against your last reveal eg. I reveal x_4 and it is checked with -- hash(x_4) == x_5.
There are multiple other randomness generation schemes which are thoroughly analyzed.</p>
<p><strong>Problems to try out</strong>
Implement Casper FFG with no slashing</p>
<ul>
<li>Send <code>DEPOSIT</code> transaction which makes you a validator.</li>
<li>Send <code>WITHDRAW</code> to get your money back.</li>
<li>Sign <code>VOTE</code> transactions of the form
<code>[checkpoint_hash, target_epoch, source_epoch, sig]</code></li>
<li>When ⅔ votes are reached for two subsequent checkpoints, the first is finalized.</li>
</ul>
<p>Extra credit
Add slashing conditions!</p>
<p>In the previous chapter we took a look at what proof of stake means. In this chapter we will dive deeper and look into several attacks on proof of stake. PoS has several attacks unique to it that come with designing a system that relies on economic incentives.</p>
<p>The first part about analysing any PoS system is to understand how robust the system is against attacks. To be robust against attacks, a system should fundamentally be able to prevent, detect and finally punish dishonest activity.</p>
<p>In the previous chapter we talked about how PoS systems are designed in order to prevent someone from acting maliciously. In this chapter we will focus on the detection and punishment aspect of the security of PoS systems.</p>
<p>In order to punish malicious behavior, it is important to first be able to detect and attribute the fault to a certain malicious node. Fault attribution is broadly classified into 2 categories:</p>
<ul>
<li>Uniquely attributable faults
<ul>
<li>There exists proof of who committed some fault and so we can attribute it to a unique actor.</li>
<li>Egs. Double Spending attacks</li>
</ul></li>
<li>Non-uniquely attributable faults
<ul>
<li>When faults occur and we cannot identify a single perpetrator.</li>
<li>Egs. Offline nodes vs DoSing of a Node</li>
</ul></li>
</ul>
<p>Uniquely attributable faults enables the system to punish the malicious actor. Penalties for non-uniquely attributable faults must often be dispersed amongst all possible offenders. This means that people who did nothing wrong can receive penalties!</p>
<p>Griefing analysis
An attacker may intentionally causes non-uniquely attributable faults in order to reduce someone else’s payoff. This is called griefing.
We can analyze these griefing attacks with the reduction in attacker’s payoff vs reduction in victim payoffs. This ratio is called the griefing factor.
A griefing factor of 1:1 means that for every unit of value the attacker loses in penalties, the victim node loses an equal amount.
A griefing factor of 1:2 means for every unit of value the attacker loses, the victim loses twice that… and so on.
Discouragement attacks
A particular attack can be built out of griefing which is worth noting, this is the discouragement attack.
In a discouragement attack, the attacker reduces the expected payoff for honest nodes. This can result in fewer honest nodes participating in the protocol.
This attack can be coupled with subsequent attacks which take advantage of the honest node discouragement.
In Casper FFG, a discouragement attack can look like the following:</p>
<ol>
<li>Discourage -- reduce the expected payoff for honest nodes by going offline to make honest nodes appear to be censoring.</li>
<li>Wait -- Rational nodes will realize that their expected payoff has gone down, and so will withdraw their deposits and no longer participate in consensus.</li>
<li>Attack -- Cause a safety failure. This will be significantly cheaper as many of the deposits will have been withdrawn.
For a more thorough analysis framework of PoS you can see this chart</li>
</ol>
<p>Attacks and Defenses using primitives:</p>
<p><strong>Cryptographic attacks:</strong></p>
<ul>
<li>Timing Attacks</li>
<li>Grinding</li>
<li>On Anti-Pre-Revelation Games</li>
<li>Nothing at Stake</li>
</ul>
<p><strong>Game Theory attacks</strong></p>
<ul>
<li>Selfish mining</li>
<li>Bribing attacks</li>
<li>Long Range</li>
<li>The P + epsilon Attack</li>
<li>Censorship</li>
<li>The Problem of Censorship</li>
<li>Pooling and related attacks</li>
</ul>
<p><strong>Network attacks</strong></p>
<ul>
<li>Eclipse Attacks</li>
<li>Timejacking</li>
<li>Spam attacks</li>
</ul>
<p><strong>Distributed Systems perspective:</strong></p>
<ul>
<li>On Settlement Finality</li>
</ul>
</span></div></article></div><div class="docLastUpdate"><em>Last updated on 8/17/2019 by burrrata</em></div><div class="docs-prevnext"></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#working-draft">WORKING DRAFT</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/cryptoeconomics-study-dao/" class="nav-home"></a><div><h5>Course</h5><a href="/cryptoeconomics-study-dao/docs/en/getting-started/welcome">Getting Started</a><a href="/cryptoeconomics-study-dao/en/coding-challenges">Coding Challenges</a></div><div><h5>Community</h5><a href="https://rinkeby.aragon.org/#/0xEAA147020b006e6Bfe9e3e1A9f1FaD330A9E20F5/">DAO</a><a href="https://forum.cryptoeconomics.study/">Forum</a><a href="/cryptoeconomics-study-dao/en/users.html">Contributors</a></div><div><h5>More</h5><a href="/cryptoeconomics-study-dao/blog">Blog</a><a href="https://github.com/cryptoeconomics-study-dao/">GitHub</a></div></section><section class="copyright">Copyright © 2019 Cryptoeconomics.Study</section></footer></div></body></html>